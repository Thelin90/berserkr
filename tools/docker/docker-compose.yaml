version: '3.0'
services:
        # berserkr-app
        berserkr-app:
                container_name: berserkr-app
                image: berserkr-app
                build:
                        context: ../../
                        dockerfile: tools/docker/Dockerfile
                depends_on:
                  - minio
                network_mode: 'host'
        # MinIO simulate S3 for local smoke and unit/integration testing
        minio:
                image: minio/minio
                ports:
                        - '9000:9000'
                volumes:
                        - ./test/.minio/data:/export
                        - ./test/.minio/config:/root/.minio
                environment:
                        - 'MINIO_ACCESS_KEY=AKIAIOSFODNN7EXAMPLE'
                        - 'MINIO_SECRET_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY'
                command: server /export
        # Initial raw data
        createbuckets:
                image: minio/mc
                links:
                        - minio
                restart: on-failure
                entrypoint: >
                        /bin/sh -c "
                          echo Waiting for minio service to start...;
                          while ! nc -z minio 9000;
                          do
                            sleep 1;
                          done;
                          echo Connected!;
                          mc config host add myminio http://minio:9000 AKIAIOSFODNN7EXAMPLE wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY;
                          /usr/bin/mc rm --recursive --force myminio/onlineretailraw
                        /usr/bin/mc rm --recursive --force onlineretailparquet
                          /usr/bin/mc mb myminio/onlineretailraw;
                          /usr/bin/mc mb myminio/onlineretailparquet;
                          /usr/bin/mc policy download myminio/local-events-segmentation;
                          /usr/bin/mc policy upload myminio/local-events-segmentation;
                          exit 0;
                        "
networks:
  berserkr-app-default:
